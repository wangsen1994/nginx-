## Nginx基础架构

本节主要目的：

* 了解Nginx的基本设计思路

* 从具体代码了解Nginx的启动、运行和退出

### Nginx的架构设计

nginx采用高度抽象的模块接口设计，其接口只设计模块的初始化、退出以及对配置项的处理，这样也使得nginx比较简单地实现了动态可修改性，即在保持服务正常运行下使系统功能发生改变。ngx_module_t中ctx成员一般用于表示不同类型的模块中一种类型模块所具备的通用性接口。type成员用于区别不同领域的模块。配置类型模块是唯一一种只有1个模块的模块类型，是nginx最底层的模块，指导所有模块以配置项为核心来提供功能。

官方Nginx共五大类型的模块：核心模型、配置模块、事件模块、HTTP模块、mail模块。核心模块与配置模块是其他模块的基础，而事件模块是HTTP模块与mail模块的基础。核心类型模块中共有6个具体模块，分别是ngx_core_module、ngx_errlog_module、ngx_event_module、ngx_openssl_module、ngx_http_module、ngx_mail_module。ngx_core_module_t是以配置项的解析作为基础的，使用解析出的配置项初始化核心模块的功能。这使得每个核心模块可以定义全新的模块类型，如ngx_events_module定义了NGX_EVENT_MODULE模块类型，所有事件模块的加载操作不是由Nginx框架完成的，而是由ngx_events_core_module模块负责的。

Nginx采用完全的事件驱动架构来处理业务，对于传统web服务器而言，其采用进程或线程来作为事件消费者，而nginx的事件消费者只是被事件分发者短期调用而已。这种设计使得网络性能、用户感知的请求时延都得到了提升，系统的吞吐量都会由于事件的及时响应而增大。但这也带来一个严重问题，即每个事件消费者都不能有阻塞行为。

事件驱动的框架带来了请求的多阶段异步处理，异步处理与多阶段是相辅相成的，只有把请求分为多阶段，才有所谓的异步处理（这种框架只能说对于提高并发量有比较好的效果，但对于处理复杂的业务逻辑，光靠事件来驱动可能是无法完成的，或者完成得不好）。

一般请求阶段的划分：1、将阻塞的方法分解为两个阶段 2、将阻塞方法按照时间划分 3、使用定时器划分 4、将无法划分的阻塞方法，则使用独立的进程执行。

nginx采用管理进程 + 多工作进程的设计，优点：利用多核系统并发、负载均衡、管理进程负责监控工作进程的状态，并负责管理其行为，使用信号来进行进程间通信。

### Nginx运行流程

启动流程：

* 1、根据命令行得到配置文件路径
* 2、如果处于升级中，则监听环境变量（NGINX）里传递的监听句柄
* 3、调用所有核心模块的create_conf方法生成存放配置项的结构体
* 4、针对所有核心模块解析nginx.conf配置文件
* 5、调用所有核心模块的ini_conf方法
* 6、创建目录、打开文件、初始化共享内存等进程间通信方式
* 7、打开由各Nginx模块从配置文件中读到的监听端口
* 8、调用所有模块的ini_module方法
* 9、启动子进程调用所有模块ini_process

注意close_on_exec这个设置
